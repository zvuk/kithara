stages:
  - lint
  - test
  - quality

default:
  image: rust:1.88
  tags:
    - cce-feature
  before_script:
    - apt-get update -qq && apt-get install -y -qq libasound2-dev

cache: &cargo-cache
  key:
    files:
      - Cargo.lock
  paths:
    - .cargo/bin/
    - .cargo/registry/
    - .cargo/git/
    - target/

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

# --- lint stage ---

lint:
  stage: lint
  variables:
    QUALITY_MIN_UNIMOCK_TRAITS: "15"
    QUALITY_MIN_RSTEST_CASES: "350"
    QUALITY_MIN_PERF_TEST_FILES: "5"
    QUALITY_MIN_BENCH_TARGETS: "1"
    QUALITY_MAX_LOCAL_HTTP_SERVERS: "0"
  before_script:
    - apt-get update -qq && apt-get install -y -qq libasound2-dev
    - rustup component add clippy
    - rustup toolchain install nightly --component rustfmt
  script:
    - bash scripts/ci/lint.sh
  artifacts:
    paths:
      - target/quality-report.md
      - target/trait-mock-audit.md
      - target/rstest-audit.md
    expire_in: 30 days

deny:
  stage: lint
  before_script:
    - test -f "$CARGO_HOME/bin/cargo-deny" || cargo install cargo-deny --locked
  script:
    - cargo deny check

machete:
  stage: lint
  before_script:
    - test -f "$CARGO_HOME/bin/cargo-machete" || cargo install cargo-machete --locked
  script:
    - cargo machete
  allow_failure: true

arch:
  stage: lint
  before_script: []
  script:
    - bash scripts/ci/check-arch.sh

# --- test stage ---

test:
  stage: test
  needs: [lint]
  timeout: 20 minutes
  before_script:
    - apt-get update -qq && apt-get install -y -qq libasound2-dev
    - test -f "$CARGO_HOME/bin/cargo-nextest" || cargo install cargo-nextest --locked
  script:
    - cargo nextest run --workspace

msrv:
  stage: test
  needs: [lint]
  image: rust:1.88
  script:
    - cargo check --workspace

wasm:
  stage: test
  needs: [lint]
  before_script:
    - rustup target add wasm32-unknown-unknown
  script:
    - cargo check -p kithara-wasm --target wasm32-unknown-unknown --no-default-features
    - cargo check -p kithara-storage --target wasm32-unknown-unknown
    - cargo check -p kithara-net --target wasm32-unknown-unknown
    - cargo check -p kithara-stream --target wasm32-unknown-unknown
    - cargo check -p kithara-assets --target wasm32-unknown-unknown
    - cargo check -p kithara-hls --target wasm32-unknown-unknown
    - cargo check -p kithara-decode --target wasm32-unknown-unknown

hack:
  stage: test
  needs: [lint]
  timeout: 30 minutes
  before_script:
    - apt-get update -qq && apt-get install -y -qq libasound2-dev
    - test -f "$CARGO_HOME/bin/cargo-hack" || cargo install cargo-hack --locked
  script:
    - cargo hack check --feature-powerset --no-dev-deps --depth 2 --workspace
      --exclude kithara-wasm
  allow_failure: true

semver:
  stage: test
  needs: [lint]
  before_script:
    - apt-get update -qq && apt-get install -y -qq libasound2-dev
    - test -f "$CARGO_HOME/bin/cargo-semver-checks" || cargo install cargo-semver-checks --locked
  script:
    - cargo semver-checks check-release --workspace
  allow_failure: true
  rules:
    - changes:
        - crates/*/src/**/*
        - crates/*/Cargo.toml

# --- quality stage ---

coverage:
  stage: quality
  needs: [test]
  variables:
    COVERAGE_MIN: "80"
  before_script:
    - apt-get update -qq && apt-get install -y -qq libasound2-dev
    - test -f "$CARGO_HOME/bin/cargo-tarpaulin" || cargo install cargo-tarpaulin --locked
  script:
    - bash scripts/ci/coverage.sh
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura.xml
    expire_in: 30 days

perf:
  stage: quality
  needs: [test]
  script:
    - bash scripts/ci/perf-test.sh
  artifacts:
    paths:
      - perf-results.txt
    expire_in: 30 days
  rules:
    - changes:
        - crates/**/*
        - tests/perf/**/*
        - Cargo.toml
        - Cargo.lock

bench:
  stage: quality
  needs: [test]
  script:
    - bash scripts/ci/bench-test.sh
  artifacts:
    paths:
      - bench-results.txt
    expire_in: 30 days
  rules:
    - changes:
        - crates/kithara-abr/**/*
        - Cargo.toml
        - Cargo.lock
