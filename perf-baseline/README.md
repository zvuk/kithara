# Performance Baselines

This directory stores baseline performance measurements for regression detection.

## Structure

```
perf-baseline/
  baseline-run.txt             # Full perf test output (baseline)
  README.md                    # This file
```

## CI Integration

Performance tests run automatically on:
- **Pull Requests**: Compare against main branch baseline
- **Main branch commits**: Update baseline for future comparisons

See `.github/workflows/perf.yml` for workflow details.

## Usage

### Initial Baseline

Run perf tests and establish initial baseline:

```bash
cd /Users/litvinenko-pv/code/kithara
cargo test --features perf --release --test-threads=1 -- --ignored
cp target/hotpath-*.json perf-baseline/
git add perf-baseline/
git commit -m "perf: establish initial baseline"
```

### After Optimization

After confirming an optimization improves performance:

```bash
# Run perf tests
cargo test --features perf --release --test-threads=1 -- --ignored

# Compare with baseline
python scripts/compare_perf.py \
  --current target/hotpath-*.json \
  --baseline perf-baseline/hotpath-*.json \
  --threshold 10%

# If improvement confirmed, update baseline
cp target/hotpath-*.json perf-baseline/
git add perf-baseline/
git commit -m "perf: update baseline after [optimization description]"
```

### Regression Detection

CI automatically compares PR performance against main branch baseline:

```bash
# In CI (triggered on PR)
cargo test --features perf --release --test-threads=1 -- --ignored
python scripts/compare_perf.py \
  --current target/hotpath-*.json \
  --baseline perf-baseline/hotpath-*.json \
  --threshold 10%  # Fail if >10% slower
```

## Baseline Format

Baselines are JSON files generated by hotpath-rs containing:

```json
{
  "test_name": "resampler_Fast",
  "paths": {
    "resampler_process": {
      "total_time": 1234.56,
      "call_count": 1000,
      "avg_time": 1.23
    }
  }
}
```

## Notes

- Baselines are machine-specific (CPU, RAM, OS)
- CI baselines run on standardized GitHub Actions runners
- Local baselines help detect regressions during development
- Update baselines only after verifying optimization is real
