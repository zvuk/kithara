name: Performance Tests

on:
  pull_request:
    paths:
      - 'crates/**'
      - 'tests/perf/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  push:
    branches:
      - main
    paths:
      - 'crates/**'
      - 'tests/perf/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  perf-tests:
    name: Run Performance Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev

      - name: Restore perf baseline
        if: github.event_name == 'pull_request'
        id: restore-baseline
        uses: actions/cache/restore@v4
        with:
          path: baseline-results.txt
          key: perf-baseline-will-not-match
          restore-keys: perf-baseline-

      - name: Run performance tests
        run: |
          cargo test -p kithara-integration-tests --features perf --release \
            -- --ignored --test-threads=1 --nocapture 2>&1 | tee perf-results.txt

      - name: Save perf baseline
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: perf-results.txt
          key: perf-baseline-${{ github.sha }}

      - name: Compare with baseline
        if: github.event_name == 'pull_request' && steps.restore-baseline.outputs.cache-hit != ''
        id: compare
        run: |
          result=$(bash scripts/compare_perf.sh perf-results.txt baseline-results.txt 10 2>&1) || true
          echo "$result"
          {
            echo 'comparison<<EOF'
            echo "$result"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: perf-results
          path: perf-results.txt
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        env:
          BASELINE_HIT: ${{ steps.restore-baseline.outputs.cache-hit }}
          COMPARISON: ${{ steps.compare.outputs.comparison }}
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('perf-results.txt', 'utf8');

            const summaries = results.match(/\[hotpath\] timing[\s\S]*?(?=\n\n|\ntest |$)/g) || [];

            const hasBaseline = process.env.BASELINE_HIT !== '';
            const comparison = process.env.COMPARISON;

            let body = `## Performance Test Results\n\n`;

            if (hasBaseline && comparison) {
              body += `### Baseline Comparison\n\n\`\`\`\n${comparison}\n\`\`\`\n\n`;
            } else {
              body += `> No baseline found. Results from this run will become the baseline after merge to main.\n\n`;
            }

            body += `<details>\n<summary>Hotpath Summaries</summary>\n\n\`\`\`\n` +
              summaries.slice(0, 5).join('\n\n') +
              `\n\`\`\`\n</details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
